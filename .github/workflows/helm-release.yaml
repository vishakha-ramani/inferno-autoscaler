name: Release – Docker Image & Publish Helm Chart to GHCR

on:
  release:
    types: [published]

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------
      # 1. Checkout repo
      # -----------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------------------
      # 2. Determine version from tag (v0.0.4 → 0.0.4)
      # -----------------------------------------
      - name: Determine version from tag
        id: version
        run: |
          RAW_TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${RAW_TAG#v}"
          echo "tag=$RAW_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # -----------------------------------------
      # 3. Set up QEMU + Buildx
      # -----------------------------------------
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------
      # 4. Log in to GHCR for Docker push
      # -----------------------------------------
      - name: Docker login GHCR
        run: echo "${{ secrets.CR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # -----------------------------------------
      # 5. Build and push multi-arch Docker image
      # -----------------------------------------
      - name: Build and push container image
        run: |
          IMAGE="ghcr.io/llm-d-incubation/workload-variant-autoscaler"
          TAG="${{ steps.version.outputs.tag }}"

          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --push \
            -t $IMAGE:$TAG \
            -t $IMAGE:latest .

      # -----------------------------------------
      # 6. Patch Helm chart (Chart.yaml + values.yaml)
      # -----------------------------------------
      - name: Update Helm chart files
        run: |
          CHART_DIR="charts/workload-variant-autoscaler"
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"

          # Chart.yaml updates
          sed -i "s/^version:.*/version: ${VERSION}/"       $CHART_DIR/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${TAG}\"/" $CHART_DIR/Chart.yaml

          # values.yaml—update container tag
          sed -i "s/^  tag:.*/  tag: \"${TAG}\"/" $CHART_DIR/values.yaml

          echo "Updated Chart.yaml:"
          cat $CHART_DIR/Chart.yaml

          echo "Updated values.yaml:"
          cat $CHART_DIR/values.yaml

      # -----------------------------------------
      # 7. Install Helm
      # -----------------------------------------
      - name: Install Helm
        uses: azure/setup-helm@v3

      # -----------------------------------------
      # 8. Login to GHCR for chart publishing
      # -----------------------------------------
      - name: Login to GHCR (Helm)
        env:
          GITHUB_TOKEN: ${{ secrets.CR_TOKEN }}
        run: |
          echo "$GITHUB_TOKEN" | \
            helm registry login ghcr.io \
              --username ${{ github.actor }} \
              --password-stdin

      # -----------------------------------------
      # 9. Package Helm chart
      # -----------------------------------------
      - name: Package chart
        run: |
          helm package charts/workload-variant-autoscaler --destination .

      # -----------------------------------------
      # 10. Push chart to GHCR
      # -----------------------------------------
      - name: Push Helm chart
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CHART_FILE="workload-variant-autoscaler-${VERSION}.tgz"

          helm push "$CHART_FILE" \
            oci://ghcr.io/llm-d-incubation/workload-variant-autoscaler

      # -----------------------------------------
      # 11. Commit updated chart files
      # -----------------------------------------
      - name: Commit updated Helm chart files
        env:
          GITHUB_TOKEN: ${{ secrets.CR_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add charts/workload-variant-autoscaler/Chart.yaml
          git add charts/workload-variant-autoscaler/values.yaml

          git commit -m "Release ${{ steps.version.outputs.tag }}: update Chart.yaml and values.yaml" || echo "No changes to commit"
          git remote set-url origin https://${{ github.actor }}:$GITHUB_TOKEN@github.com/${{ github.repository }}.git
          git push
